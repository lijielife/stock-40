<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="Mosaddek">
		<meta name="keyword" content="FlatLab, Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
		<link rel="shortcut icon" href="img/favicon.html">

		<title>个人主页</title>

		<!-- Bootstrap core CSS -->
		<!--<link href="css/bootstrap.min.css" rel="stylesheet">-->
		<link href="//cdn.bootcss.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
		<link href="css/bootstrap-reset.css" rel="stylesheet">
		<!--external css-->
		<link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
		<link href="assets/jquery-easy-pie-chart/jquery.easy-pie-chart.css" rel="stylesheet" type="text/css" media="screen" />
		<!--<link rel="stylesheet" href="css/owl.carousel.css" type="text/css">-->
		<!-- Custom styles for this template -->
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet" />

		<!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
		<!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
    <![endif]-->
		<style>
			.custom-bar-chart .bar {
				width: 6%;
				display: inline-block;
    		float: none;
			}
			
			.custom-bar-chart {
				overflow-x: auto;
				white-space: nowrap;
				padding-top: 40px;
				padding-bottom: 40px;
				overflow-y: hidden;
				margin: 0;
			}
			
			.panel-body {
				padding: 0;
			}
		</style>
	</head>

	<body>

		<section id="container" class="">
			<!--header start-->
			<header class="header white-bg">
				<div class="sidebar-toggle-box">
					<div data-original-title="菜单" data-placement="right" class="icon-reorder tooltips"></div>
				</div>
				<!--logo start-->
				<a href="#" class="logo">客户<span>E</span></a>
				<!--logo end-->				
				<div class="top-nav ">
					<!--search & user info start-->
					<ul class="nav pull-right top-menu">
						
						<!-- user login dropdown start-->
						<li class="dropdown">
							<a data-toggle="dropdown" class="dropdown-toggle" href="#">
								<img alt="" src="img/avatar1_small.jpg">
								<span class="username" id="username"></span>
								<b class="caret"></b>
							</a>
							<ul class="dropdown-menu extended logout">
								<div class="log-arrow-up"></div>								
								<li>
									<a href="login.html" class="log-out"><i class="icon-key"></i> 登出</a>
								</li>
							</ul>
						</li>
						<!-- user login dropdown end -->
					</ul>
					<!--search & user info end-->
				</div>
			</header>
			<!--header end-->
			<!--sidebar start-->
			<aside>
				<div id="sidebar" class="nav-collapse ">
					<!-- sidebar menu start-->
					<ul class="sidebar-menu">
						<li class="active">
							<a class="" href="home.html">
								<i class="icon-dashboard"></i>
								<span>仪表盘</span>
							</a>
						</li>
						<li class="sub-menu">
							<a href="customers.html" class="">
								<i class="icon-book"></i>
								<span>客户</span>
							</a>
						</li>
						<li class="sub-menu">
							<a href="supplier.html" class="">
								<i class="icon-book"></i>
								<span>供应商</span>
							</a>
						</li>
						<li>
							<a href="goods.html" class="">
								<i class="icon-book"></i>
								<span>商品</span>
							</a>
						</li>
						<li>
							<a href="records.html" class="">
								<i class="icon-book"></i>
								<span>进货/销售/退货记录</span>
							</a>
						</li>
					</ul>
					<!-- sidebar menu end-->
				</div>
			</aside>
			<!--sidebar end-->
			<!--main content start-->
			<section id="main-content">
				<section class="wrapper">
					<!--state overview start-->
					<div class="row state-overview">
						<div class="col-lg-3 col-sm-6">
							<section class="panel">
								<div class="symbol blue">
									<i class="icon-archive"></i>
								</div>
								<div class="value">
									<h1 id="stock"></h1>
									<p>总进货费(元)</p>
								</div>
							</section>
						</div>
						<div class="col-lg-3 col-sm-6">
							<section class="panel">
								<div class="symbol green">
									<i class="icon-shopping-cart"></i>
								</div>
								<div class="value">
									<h1 id="sales"></h1>
									<p>总销售费(元)</p>
								</div>
							</section>
						</div>
						<div class="col-lg-3 col-sm-6">
							<section class="panel">
								<div class="symbol terques">
									<i class="icon-beaker"></i>
								</div>
								<div class="value">
									<h1 id="profits"></h1>
									<p>总利润(元)</p>
								</div>
							</section>
						</div>
						<div class="col-lg-3 col-sm-6">
							<section class="panel">
								<div class="symbol red">
									<i class="icon-bar-chart"></i>
								</div>
								<div class="value">
									<h1 id="inventory"></h1>
									<p>总库存价值(元)</p>
								</div>
							</section>
						</div>
						<div class="col-lg-3 col-sm-6">
							<section class="panel">
								<div class="symbol yellow">
									<i class="icon-reply"></i>
								</div>
								<div class="value">
									<h1 id="wreck"></h1>
									<p>总折损费</p>
								</div>
							</section>
						</div>
					</div>
					<!--state overview end-->

					<div class="row">
						<div class="col-lg-8">
							<!--custom chart start-->
							<div class="border-head">
								<h3>数据统计</h3>
							</div>
							<div class="panel-body progress-panel">
								<div class="task-progress">
									<h1 id="statisticalText">日记录</h1>
									<p id="dataText">进货费用</p>
								</div>
								
								<div class="task-option">
									<select class="styled" id="statisticalType">
										<option value="2">日记录</option>
										<option value="1">月记录</option>										
									</select>
									<select class="styled" id="dataType">
										<option value="1">进货费用</option>
										<option value="2">销售额</option>
										<option value="3">折损费用</option>
										<option value="4">利润</option>
									</select>
								</div>
							</div>
							<div class="custom-bar-chart">
								
							</div>
							<!--custom chart end-->
						</div>

					</div>
				</section>
			</section>
			<!--main content end-->
		</section>

		<!-- js placed at the end of the document so the pages load faster -->
		<!--<script src="js/jquery.js"></script>
    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>-->
		<script src="//cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
		<!--<script src="//cdn.bootcss.com/jquery/1.8.3/jquery.min.js"></script>-->
		<script src="//cdn.bootcss.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
		<!--<script src="js/jquery.scrollTo.min.js"></script>-->
		<script src="//cdn.bootcss.com/jquery-scrollTo/1.4.6/jquery.scrollTo.min.js"></script>
		<!--<script src="js/jquery.nicescroll.js" type="text/javascript"></script>-->
		<script src="//cdn.bootcss.com/jquery.nicescroll/3.5.1/jquery.nicescroll.min.js"></script>
		<!--<script src="js/jquery.sparkline.js" type="text/javascript"></script>-->
		<!-- <script src="//cdn.bootcss.com/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    <script src="assets/jquery-easy-pie-chart/jquery.easy-pie-chart.js"></script>-->
		<!--<script src="js/owl.carousel.js" ></script>-->
		<!--<script src="js/jquery.customSelect.min.js" ></script>-->
		<!--<script src="//cdn.bootcss.com/jquery.customSelect/0.4.1/jquery.customSelect.min.js"></script>-->

		<!--common script for all pages-->
		<script src="js/common-scripts.js"></script>
		<!--script for this page-->
		<!--<script src="js/sparkline-chart.js"></script>-->
		<!--<script src="js/easy-pie-chart.js"></script>-->

		<!--<script src="js/jquery.cookie.js"></script>-->
		<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

		<script>
			//custom select box
			var dataN=[];
			$(function() {
				var ticket = $.cookie("ticket");
				loginFlag(ticket);
				initData(ticket);
				statistical(2,ticket);
				$(".log-out").click(function() { //每次登录时把cookie中ticket清除
					$.cookie("ticket", '', {
						expires: -1
					});
				});
				$("#statisticalType").change(function(){
					$("#statisticalText").html($("#statisticalType").find("option:selected").text());
					statistical($("#statisticalType").val(),ticket);
				});
				$("#dataType").change(function(){
					console.log($("#dataType").find("option:selected").text());
					$("#dataText").html($("#dataType").find("option:selected").text());
					initStatis();
				});				
			});
			//判断当前用户是否已经登录
			function loginFlag(ticket) {
				if(ticket == '' || ticket == undefined) {
					location.href = 'login.html';
				}
				$("#username").html($.cookie("name"));
			}
			function initStatis(){
				var statisticalType = $("#statisticalType").val();
				var dataType = $("#dataType").val();
				$(".custom-bar-chart").empty();
				if(statisticalType==1){//月记录 10 个月
					//先获取到当前要统计的数据中最大的一个
					var maxData=1;
					for(var i=0;i<12;i++){
						if(maxData < getData(dataN[i],dataType)){
							maxData = getData(dataN[i],dataType);
						}
					}
					
					for(var i=(dataN.length-2);i>=0;i--){
						$(".custom-bar-chart").append('<div class="bar">'+
							'<div class="title">'+dataN[i].time.substr(2,5)+'</div>'+
							'<div class="value tooltips" data-original-title="'+getData(dataN[i],dataType)+'" data-toggle="tooltip" data-placement="top" style="height: '+(getData(dataN[i],dataType)/maxData)*100+'%;"></div>'+
						'</div>');
					}
				} else {//天记录30天
					var maxData=1;
					for(var i=0;i<30;i++){
						if(maxData < getData(dataN[i],dataType)){
							maxData = getData(dataN[i],dataType);
						}
					}					
					for(var i=(dataN.length-1);i>0;i--){
						$(".custom-bar-chart").append('<div class="bar">'+
							'<div class="title">'+dataN[i].time.substr(5,5)+'</div>'+
							'<div class="value tooltips" data-original-title="'+getData(dataN[i],dataType)+'" data-toggle="tooltip" data-placement="top" style="height: '+(getData(dataN[i],dataType)/maxData)*100+'%;"></div>'+
						'</div>');
					}					
				}
				$('.tooltips').tooltip();
			}
			function getData(data,type){
				if(type==1){
					return data.productionPrice+data.otherPrice;
				} else if (type == 2){
					return data.sellPrice;
				} else if (type == 3){
					return data.damagePrice;
				} else {
					return data.profitPrice;
				}
			}
			function statistical(type,ticket){
					var _datenow=new Date(new Date((new Date())-1*24*3600*1000));
					var beginTime='';					
					if(type == 1){
						beginTime = _datenow.getFullYear()-1+"-"+(_datenow.getMonth()+1)+"-1 00:00:00"
					} else {
						var _date30old=new Date((+_datenow)-29*24*3600*1000);
						beginTime = _date30old.format("yyyy-MM-dd 00:00:00");
					}
					var endTime = _datenow.format("yyyy-MM-dd hh:mm:ss");				 
				$.ajax({
					type: "GET",
					url: 'http://123.57.141.203:8314/stat/users',
					dataType: 'json',
					data: {
						"beginTime": beginTime,
						"endTime": endTime,
						"timeType": type
					},
					headers: {
						"ticket": ticket
					},
					success: function(data) {
						console.log(data);
						if(data.code == 200) {
							dataN = data.data;
							initStatis();
						} else if(data.code == 401) {
							location.href = "login.html";
						} else {
							console.log(data);
						}
					},
					// 调用出错执行的函数
					error: function() {
						console.log('statistical error');
					}
				});
			}
			function initData(ticket) {
				$.ajax({
					type: "GET",
					url: 'http://123.57.141.203:8314/users/stat',
					dataType: 'json',
					async: false,
					headers: {
						"ticket": ticket
					},
					success: function(data) {
						if(data.code == 200) {
							var dataN = data.data;
							$('#stock').text(dataN.productionPrice + dataN.otherPrice);
							$('#sales').text(dataN.sellPrice);
							$('#profits').text(dataN.profitPrice);
							$('#inventory').text(dataN.stockPrice);
							$('#wreck').text(dataN.damagePrice);
						} else if(data.code == 401) {
							location.href = "login.html";
						} else {
							console.log(data);
						}
					},
					// 调用出错执行的函数
					error: function() {
						console.log('initData error');
					}
				});
			}
			Date.prototype.format = function(format) {  
			    /* 
			     * eg:format="yyyy-MM-dd hh:mm:ss"; 
			     */  
			    var o = {  
			        "M+" : this.getMonth() + 1, // month  
			        "d+" : this.getDate(), // day  
			        "h+" : this.getHours(), // hour  
			        "m+" : this.getMinutes(), // minute  
			        "s+" : this.getSeconds(), // second  
			        "q+" : Math.floor((this.getMonth() + 3) / 3), // quarter  
			        "S" : this.getMilliseconds()  
			        // millisecond  
			    }  
			  
			    if (/(y+)/.test(format)) {  
			        format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4  
			                        - RegExp.$1.length));  
			    }  
			  
			    for (var k in o) {  
			        if (new RegExp("(" + k + ")").test(format)) {  
			            format = format.replace(RegExp.$1, RegExp.$1.length == 1  
			                            ? o[k]  
			                            : ("00" + o[k]).substr(("" + o[k]).length));  
			        }  
			    }  
			    return format;  
			}
		</script>

	</body>

</html>